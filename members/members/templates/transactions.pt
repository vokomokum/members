<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:tal="http://xml.zope.org/namespaces/tal">
    <div metal:use-macro="view.layout.macros['master']">
        <div metal:fill-slot="content">

    <h1>
        Transactions in month ${view.month}/${view.year}
    </h1>
    
    <div id="prevnext">
        <a href="${portal_url}/transactions/${view.month_info.prev_year}/${view.month_info.prev_month}">
            &lt;&lt;&nbsp;${view.month_info.prev_month}/${view.month_info.prev_year}
        </a>
        &nbsp; &nbsp; &nbsp;
        <a href="${portal_url}/transactions/${view.month_info.next_year}/${view.month_info.next_month}">
            ${view.month_info.next_month}/${view.month_info.next_year}&nbsp;&gt;&gt;
        </a>
    </div>
    
    <!-- show deletion confirmation -->
    <div id="deletion-confirmation" tal:condition="python: hasattr(view, 'cdo')">
        <div class="warn">Really delete transaction "${view.cdo}"?</div>
        <a href="${portal_url}/transaction/${view.cdo.id}/delete">
            <button>Yes</button>
        </a>    
        <a onclick="javascript:$('#deletion-confirmation').hide()">
            <button>No</button>
        </a>    
    </div>

    <div class="new-transaction-form" id="stylized-form">
        <form action="${portal_url}/transactions/new"
              method="post">
        
            <div class="form-title">
                Create new transaction: <a onclick="$('#form-data').toggle()">show/hide</a>
            </div>
            <div id="form-data" style="display:none;">
                <div class="form-row">
                    <label for="ttype_id">Type:</label>
                    <select onchange="javascript:togglePartnerOrderSelect();"
                            name="ttype_id" id="ttype-select">
                        <option value="--">--</option>
                        <tal:block tal:repeat="tt view.transaction_types">
                            <option value="${tt.id}">${tt} (${python:{'pos':'+', 'neg':'-', '---':'+ or -'}[tt.pos_neg]})</option>
                        </tal:block>
                    </select>
                    <div id="member">
                        <label for="mem_id">Member:</label>
                        <select name="mem_id" id="mem_id" class="chzn-select">
                            <option id="mem-default-option" value="--">[ID] Name (active)</option>
                            <tal:block tal:repeat="m view.members">
                                <option tal:define="active python:{True:'yes', False:'no'}[m.mem_active]"
                                        value="${m.mem_id}">[${m.mem_id}] ${m.fullname} (${active})</option>
                            </tal:block>
                        </select>
                    </div>
                    <div id="wholesaler">
                        <label for="wh_id">Wholesaler:</label>
                        <select name="wh_id">
                            <option id="wh-default-option" value="--">--</option>
                            <tal:block tal:repeat="w view.wholesalers">
                                <option value="${w.wh_id}">${w}</option>
                            </tal:block>
                        </select>
                    </div>
                    <div id="vers_supplier">
                        <label for="vers_id">Vers Supplier:</label>
                        <select name="vers_id">
                            <option id="vers-default-option" value="--">--</option>
                            <tal:block tal:repeat="vs view.vers_suppliers">
                                <option value="${vs.id}">${vs}</option>
                            </tal:block>
                        </select>
                    </div>
                    <script language="javascript">
                        var member_types = Array();
                        var wholesaler_types = Array();
                        var vers_supplier_types = Array();
                        <tal:block tal:repeat="tt view.transaction_types">
                        <tal:block tal:condition="tt.mem_sup == 'memb'">member_types.push("${tt.id}");</tal:block>
                        <tal:block tal:condition="tt.mem_sup == 'whol'">wholesaler_types.push("${tt.id}");</tal:block>
                        <tal:block tal:condition="tt.mem_sup == 'vers'">vers_supplier_types.push("${tt.id}");</tal:block>
                        </tal:block>
                        function togglePartnerOrderSelect(){
                            var sel = $('#ttype-select')[0];
                            var sel_ttid = sel.options[sel.selectedIndex].value;
                            var sel_txt = sel.options[sel.selectedIndex].innerHTML;
                            // indicate near amount field if it needs to be positive/negative
                            <tal:block tal:repeat="tt view.transaction_types">
                            if (sel_ttid == '${tt.id}')
                                var pn = '${python:{'pos':'+', 'neg':'-', '---':'+ or -'}[tt.pos_neg]}';
                            </tal:block>
                            $('#amount-posneg').html('(' + pn + ')');
                            // toggle the partner with whom to associate
                            if (member_types.indexOf(sel_ttid) >= 0)
                                $('#member').show();
                            else 
                                $('#member').hide();
                            if (wholesaler_types.indexOf(sel_ttid) >= 0)
                                $('#wholesaler').show();
                            else 
                                $('#wholesaler').hide();
                            if (vers_supplier_types.indexOf(sel_ttid) >= 0)
                                $('#vers_supplier').show();
                            else 
                                $('#vers_supplier').hide();
                            // also toggle the order selection for some type(s)
                            if (sel_txt == 'Order Charge')
                                $('#order-div').show();
                            else 
                                $('#order-div').hide();
                        }
                        $(document).ready(function(){
                            // perform showing/hiding once
                            togglePartnerOrderSelect();
                            // make sure we're empty (some browsers are too nice)
                            $('#mem-default-option').attr('selected', 'selected')
                                                    .removeAttr('selected');
                            $('#wh-default-option').attr('selected', 'selected')
                                                   .removeAttr('selected');
                            $('#vers-default-option').attr('selected', 'selected')
                                                     .removeAttr('selected');
                            $('#order-default-option').attr('selected', 'selected')
                                                      .removeAttr('selected');
                        });
                    </script>
                    <span id="order-div" style="display:none;">
                        <label for="ord_no">Order:</label>
                        <select name="ord_no" id="order-select">
                            <option id="order-default-option" value="--">--</option>
                            <tal:block tal:repeat="o view.orders">
                                <option value="${o.id}">${o.label}</option>
                            </tal:block>
                        </select>
                    </span>
                </div>
                <div class="form-row">
                    <label for="amount">Amount <span id="amount-posneg"></span>:</label>
                    <small>EUR</small> <input type="text" size="7" maxlength="7" name="amount" />
                    <label for="day">Day:</label>
                    <select name="day">
                        <tal:block repeat="d view.days">
                            <option value="${d}" tal:condition="d != view.today">${d}</option>
                            <option value="${d}" tal:condition="d == view.today" selected="selected">${d}</option>
                        </tal:block> 
                    </select>
                    <input type="hidden" name="month" value="${view.month}" />
                    <input type="hidden" name="year" value="${view.year}" />
                    <label for="late">Late:</label>
                    <input type="checkbox" name="late" />
                </div>
                <div class="form-row">
                    <label for="comment">Comment:</label>
                    <textarea name="comment" rows="2" cols="50"></textarea>
                </div>
                <button type="submit">Create</button>
            </div>
        </form>
    </div>
    
    <h2>Summary:</h2>
    
    <div id="stylized-sums">
        <table width="100%">
            <tr id="sums-header">
                <th width="60%">Type</th>
                <th width="15%">Count</th>
                <th width="25%">Sum</th>
            </tr>
            <tr tal:repeat="tt view.transaction_types">
                <tal:block tal:condition="python: view.sums[tt.name]['count'] > 0">
                    <td>${tt.name}</td>
                    <td>${python: view.sums[tt.name]['count']}</td>
                    <td><small>EUR</small> ${python: view.sums[tt.name]['amount']}</td>
                </tal:block>
            </tr>
            <tr id="sums-overall">
                <td/>
                <td> ${python:view.overall['count']}</td>
                <td><small>EUR</small> ${python: view.overall['amount']}</td>
            </tr>
        </table> 
    </div>
    
    <h2>List:</h2>

    <form action="${portal_url}/transactions/${view.year}/${view.month}">
        Type:
        <select name="ttype">
            <option value="">All types</option>
            <tal:block tal:repeat="tt view.transaction_types">
                <option tal:condition="tt.id == view.ttid" selected="selected" value="${tt.id}">${tt.name}</option>
                <option tal:condition="tt.id != view.ttid" value="${tt.id}">${tt.name}</option>
            </tal:block>
        </select>
        Order by:
        <select name="order_by">
            <tal:block tal:repeat="oc view.order_criteria">
                <option tal:condition="oc == view.order_criterion" selected="selected" value="${oc}">${oc}</option>
                <option tal:condition="oc != view.order_criterion" value="${oc}">${oc}</option>
            </tal:block>
        </select>
        <button type="submit">Update List</button>
    </form>

    <table class="list" width="100%" align="center">
        <tr class="list-content" align="center">
            <th width="20%">Type</th>
            <th width="17%">Partner</th>
            <th width="6%">Amount</th>
            <th width="10%">Order</th>
            <th width="5%">Day</th>
            <th width="28%">Comment</th>
            <th width="5%">Late</th>
            <th width="5%"></th>
        </tr>
        <tr tal:condition="view.show_items and not transactions">
            <td colspan="8">No transactions found.</td>
        </tr>
        <tr tal:condition="not:view.show_items">
            <td colspan="8">No transactions shown. Update list to see transactions of this month.</td>
        </tr>
        <tr tal:repeat="t transactions">
            <td>${t.ttype}</td>
            <td>
                <form tal:condition="t.ttype.mem_sup == 'memb'"
                      action="${portal_url}/transaction/${t.id}/edit/setmember" method="post">
                    <select onchange="this.form.submit();" name="mem_id"
                        name="mem_id" class="chzn-select"
                        title="Select to update." style="width: 140px;">
                        <tal:block tal:repeat="m view.members">
                            <option tal:condition="m.mem_id == t.mem_id" value="${m.mem_id}" selected="selected">${m.fullname}</option>
                            <option tal:condition="m.mem_id != t.mem_id" value="${m.mem_id}">${m.fullname}</option>
                        </tal:block>
                    </select>
                </form>
                <form tal:condition="t.ttype.mem_sup == 'whol'"
                      action="${portal_url}/transaction/${t.id}/edit/setwholesaler" method="post">
                    <select onchange="this.form.submit();" name="wh_id"
                        title="Select to update." style="width: 140px;">
                        <tal:block tal:repeat="w view.wholesalers">
                            <option tal:condition="w.wh_id == t.whol_id" value="${w.wh_id}" selected="selected">${w}</option>
                            <option tal:condition="w.wh_id != t.whol_id" value="${w.wh_id}">${w}</option>
                        </tal:block>
                    </select>
                </form>
                <form tal:condition="t.ttype.mem_sup == 'vers'"
                      action="${portal_url}/transaction/${t.id}/edit/setverssupplier" method="post">
                    <select onchange="this.form.submit();" name="vers_id"
                        title="Select to update." style="width: 140px;">
                        <tal:block tal:repeat="vs view.vers_suppliers">
                            <option tal:condition="vs.id == t.vers_id" value="${vs.id}" selected="selected">${vs}</option>
                            <option tal:condition="vs.id != t.vers_id" value="${vs.id}">${vs}</option>
                        </tal:block>
                    </select>
                </form>
            </td>
            <td>
                <form action="${portal_url}/transaction/${t.id}/edit/setamount" method="post">
                    <small>EUR</small>
                    <input type="text" size="5" maxlength="7" name="amount" value="${round(t.amount, 2)}"
                        onkeydown="if (event.keyCode == 13) this.form.submit()"
                        title="Edit, then press Enter/Return key to update."/>
                </form>
            </td>
            <td>
                <a tal:condition="t.ttype.name == 'Order Charge'"
                   href="http://order.vokomokum.nl/cgi-bin/order?order_no=${t.ord_no}&amp;mem_id=${t.mem_id}"
                   title="Click to see the details of this order (you might need to login)."
                   tal:content="t.order.label">
                </a>
            </td>
            <td tal:content="t.date.day">
            </td>
            <td>
                <form action="${portal_url}/transaction/${t.id}/edit/setcomment" method="post">
                    <input type="text" size="30" maxlength="500" name="comment" value="${t.comment}"
                        onkeydown="if (event.keyCode == 13) this.form.submit()"
                        title="Edit, then press Enter/Return key to update."/>
                </form>
            </td>
            <td>
                <form action="${portal_url}/transaction/${t.id}/edit/setlate" method="post">
                    <input type="checkbox" name="late" tal:condition="t.late" 
                           checked="checked" onchange="this.form.submit();" title="Click to update."/> 
                    <input type="checkbox" name="late" tal:condition="not t.late"
                           onchange="this.form.submit();" title="Click to update."/> 
                </form>
            </td>
            <td>
                <a href="${portal_url}/transactions/${t.date.year}/${t.date.month}?confirm-deletion-of=${t.id}"
                   tal:condition="not:t.locked()" title="Delete this transaction.">
                    <img src="${portal_url}/static/img/icons/delete.gif"/>
                </a>
            </td>
        </tr>
    </table>

        </div>
    </div>
</html>
